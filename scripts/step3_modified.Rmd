---
title: "RNAseq pipeline - create your own gene matrix"
output: html_notebook
author: Cristina Venturini
modified: Carolin Turner
#  change 1: add pseudocount to all tpm values (not only zero values) to enable log2 transformation
#  change 2: deduplication step removed
---

To start we call an external script with some useful functions we will use later
```{r}
source("rnaseq_pipeline.r")
```


1) Read the matrix (example with tpm, the same can be done with the cpm file)
```{r}

#install.packages(c("dplyr", "tidyr","data.table"), dependencies = T)
library(plyr)
library(dplyr)
library(tidyr)
library(data.table)

tpm_df <- read.csv("tpm.csv",header = TRUE,as.is = TRUE,row.names = 1) # CHANGE HERE the input file name
```


2) A pseudocount of 0.001 is added to all expression values to avoid zero values and thus enable log2 transformation. We then log2 normalise all data. We write a .csv file with this data, change the file name as you like (here: example_tpm_PC0.001_log2.csv).

```{r}
tpm_df <- tpm_df + 0.001
tpmlog <- log2(tpm_df)
tpmlog$ensembl_gene_id <- row.names(tpmlog)
tpmlog <- tpmlog %>% select(ensembl_gene_id,everything()) ##make sure biomart is not loaded, it creates problems with dplyr
write.csv(tpmlog,"example_tpm_PC0.001_log2.csv",quote=FALSE,row.names = FALSE) ##CHANGE HERE the output file name
```


3) We can annotate the Ensembl gene ID to gene names 
fileName is the .csv file we saved above (example_tpm_PC0.001_log2.csv)
If needed you can change the species for annotation: hsapiens_gene_ensembl is human 
This command will save another csv file called Annotatedexample_tpm_PC0.001_log2.csv
```{r}
## try http:// if https:// URLs are not supported
#source("https://bioconductor.org/biocLite.R")
#biocLite("biomaRt")
library(biomaRt) #important to load it after
fileName <- "example_tpm_PC0.001_log2.csv"
#fileName <- "tpm.csv"
annotation("hsapiens_gene_ensembl",fileName,fileout)
```

4) We can create a density plot of our data to help us identify outlier
Two options:
- simple plot
- interactive plot 

For the simple plot run: 
```{r}
##SIMPLE PLOT
##install.packages("ggplot2","reshape")
library(ggplot2)
library(reshape)
data_melted <- melt(tpmlog)
p <- ggplot(data_melted,aes(x=value, col= variable)) + geom_density() + theme_bw() + theme(legend.position = "None")
plot(p)

##if you want to save the plot in a pdf file - uncomment the following
pdf("density_plot_PC0.001.pdf")
plot(p)
dev.off()
```


```{r, eval=FALSE}
##INTERACTIVE PLOT 
#install.packages("plotly")
#for for dev version
#devtools::install_github("ropensci/plotly")

library(plotly)
data_melted <- melt(tpmlog)
p <- ggplot(data_melted,aes(x=value, col= variable)) + geom_density() + theme_bw() + theme(legend.position = "None")
ggplotly(p)
```
